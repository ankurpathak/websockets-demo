# Run in foreground as requested
#daemon off;
worker_processes  2;

# 1. VERBOSE ERROR LOG (Level: debug)
# Path is relative to the project root where you start Nginx
error_log  instances/nginx_error.log debug;

events {
    worker_connections  1024;
}

http {
    include       /opt/homebrew/etc/nginx/mime.types;

    # Temp paths
    client_body_temp_path instances/client_body;
    proxy_temp_path       instances/proxy_temp;

    # 2. VERBOSE ACCESS LOG FORMAT
    # Added Upstream info, SSL protocol, and Request Time
    log_format verbose '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent" '
                       'RT=$request_time UT=$upstream_response_time '
                       'ADDR=$upstream_addr PROTO=$server_protocol '
                       'SSL_PROTO=$ssl_protocol CIPHER=$ssl_cipher';

    access_log  instances/nginx_access.log verbose;

    upstream spring_backend {
        # Use remote_port for better distribution on localhost
        hash $remote_port consistent;
        server demo.local:8443;
        server demo.local:8444;
        server demo.local:8445;
        server demo.local:8446;
    }

    server {
        listen 7443 ssl reuseport;
        server_name demo.local;

        ssl_certificate      /Users/ap/certs/cert.crt;
        ssl_certificate_key  /Users/ap/certs/cert.key;

        location / {
            # Ensure it is https
            proxy_pass https://spring_backend;

            # --- CRITICAL FIX FOR 502 ---
            proxy_ssl_verify off;        # Ignore self-signed cert errors
            proxy_ssl_server_name on;    # Pass SNI to the backend
            proxy_ssl_name demo.local;

            # --- 24 HOUR TIMEOUTS (The Fix) ---
            # 86400 seconds = 24 hours
            proxy_read_timeout 86400s;
            proxy_send_timeout 86400s;
            proxy_connect_timeout 60s;


            # WebSocket Support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";

            # Standard Headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
